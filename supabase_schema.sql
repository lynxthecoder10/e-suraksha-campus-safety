-- Enable PostGIS if available (optional, using float for now)

-- PROFILES TABLE
CREATE TABLE public.profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    name TEXT,
    role TEXT DEFAULT 'user', -- 'admin', 'student', 'security', 'responder'
    phone_number TEXT,
    emergency_contact TEXT,
    date_of_birth DATE,
    profile_photo TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ALERTS TABLE
CREATE TABLE public.alerts (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    type TEXT NOT NULL, -- 'medical', 'fire', 'security', 'other'
    status TEXT NOT NULL DEFAULT 'active', -- 'active', 'resolved'
    latitude DOUBLE PRECISION NOT NULL,
    longitude DOUBLE PRECISION NOT NULL,
    extra_data TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- INCIDENT REPORTS TABLE
CREATE TABLE public.incident_reports (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    description TEXT NOT NULL,
    latitude DOUBLE PRECISION NOT NULL,
    longitude DOUBLE PRECISION NOT NULL,
    status TEXT DEFAULT 'open', -- 'open', 'in_progress', 'closed'
    media_urls TEXT[], -- Array of URLs
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- REPORT COMMENTS (For Incident Reports)
CREATE TABLE public.report_comments (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    report_id BIGINT REFERENCES public.incident_reports(id) ON DELETE CASCADE,
    user_id UUID REFERENCES auth.users(id),
    comment TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- AUDIT LOGS TABLE
CREATE TABLE public.audit_logs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    admin_id UUID REFERENCES auth.users(id),
    action TEXT NOT NULL,
    target_user_id UUID REFERENCES auth.users(id),
    details TEXT,
    timestamp TIMESTAMPTZ DEFAULT NOW()
);

-- FEEDBACK TABLE
CREATE TABLE public.feedback (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    message TEXT NOT NULL,
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ROW LEVEL SECURITY (RLS)
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.alerts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.incident_reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.report_comments ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.audit_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.feedback ENABLE ROW LEVEL SECURITY;

-- POLICIES

-- Profiles: Public read (for social features), Self update
CREATE POLICY "Public profiles are viewable by everyone" 
ON public.profiles FOR SELECT USING (true);

CREATE POLICY "Users can insert their own profile" 
ON public.profiles FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update own profile" 
ON public.profiles FOR UPDATE USING (auth.uid() = id);

-- Alerts: Everyone read active, Users insert own
CREATE POLICY "Public read alerts" ON public.alerts FOR SELECT USING (true);
CREATE POLICY "Users insert alerts" ON public.alerts FOR INSERT WITH CHECK (auth.uid() = user_id);
-- Responders policy will be added later

-- Incident Reports: Users see own, Admins see all
CREATE POLICY "Users see own reports" ON public.incident_reports FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users insert reports" ON public.incident_reports FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Profile Trigger (Automatically create profile on signup)
CREATE OR REPLACE FUNCTION public.handle_new_user() 
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, name, role)
  VALUES (new.id, new.raw_user_meta_data->>'full_name', 'user');
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;

CREATE OR REPLACE TRIGGER on_auth_user_created
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- Audit Logs: Admins view all, System inserts (via triggers mostly, but allow auth for now)
CREATE POLICY "Admins view audit logs" ON public.audit_logs FOR SELECT USING (true); -- TODO: Restrict to admin role
CREATE POLICY "Auth users insert audit logs" ON public.audit_logs FOR INSERT WITH CHECK (auth.uid() = admin_id);

-- Feedback: Public insert (or auth), Admins view
CREATE POLICY "Users insert feedback" ON public.feedback FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Admins view feedback" ON public.feedback FOR SELECT USING (true); -- TODO: Restrict to admin role

-- Report Comments: Users view/insert for their own reports or if they are admin
-- Simplified: Auth users can view all comments (collaborative) or just their own.
-- Let's allow users to view comments on reports they own.
CREATE POLICY "Users view comments on own reports" 
ON public.report_comments FOR SELECT 
USING (
  EXISTS (
    SELECT 1 FROM public.incident_reports 
    WHERE id = report_comments.report_id AND user_id = auth.uid()
  )
);

CREATE POLICY "Users insert comments on own reports" 
ON public.report_comments FOR INSERT 
WITH CHECK (
  EXISTS (
    SELECT 1 FROM public.incident_reports 
    WHERE id = report_comments.report_id AND user_id = auth.uid()
  )
);

